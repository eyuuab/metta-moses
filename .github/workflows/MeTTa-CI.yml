name: MeTTaLog CI

on:
  push:
    branches: [ref/mettalog]
  pull_request:
    branches: [ref/mettalog]

jobs:
  mettalog-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Use Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Upgrade pip & install deps
        run: |
          python -m pip install --upgrade pip
          pip install numpy pyswip janus ansi2html junit2html

      - name: Install SWI-Prolog + Python embed
        run: |
          sudo apt-get update
          sudo apt-get install -y swi-prolog-nox \
                                  python3.10 python3.10-dev libpython3.10

      - name: Install MeTTaLog
        run: |
          git clone https://github.com/trueagi-io/metta-wam.git --depth 1 $HOME/metta-wam
          bash -c "source $HOME/metta-wam/INSTALL.sh --allow-system-modifications"
          echo "$HOME/metta-wam"       >> $GITHUB_PATH
          echo "$HOME/metta-wam/venv/bin" >> $GITHUB_PATH
          echo "SWIPL_BOOT_FLAGS=--no-pce"        >> $GITHUB_ENV
          echo "METTALOG_DIR=$HOME/metta-wam"     >> $GITHUB_ENV

      - name: Verify Python embed in SWI-Prolog
        run: |
          swipl \
            -g "use_module(library(python)), python_eval('import sys; print(sys.version)')" \
            -g "halt(0)"

      - name: Run MeTTaLog tests
        run: python3 scripts/run-tests.py
